<div id="front-card" class="card-content">
    {{#正面}}
        <div id="audio-container"></div>

        <label>播放时间（秒）：</label>
        <input type="number" id="playTime" value="5">

        <label>暂停时间（秒）：</label>
        <input type="number" id="pauseTime" value="6">

        <label>倒退时间（秒）：</label>
        <input type="number" id="reverseTime" value="1">

        <button id="startPause">开始自动暂停</button>
        <button id="stopPause">停止</button>
        <button id="reversePlay">倒放</button>
        <button id="loopToggle">循环播放</button>
    {{/正面}}
</div>

<style>
    input, button, label, audio {
        display: block;
        margin-top: 10px;
    }
</style>

<script>
    window.audio = null;
    window.pauseInterval = null;
    window.isLooping = true;
    window.isPausedManually = false;

    // 初始化音频
    function initializeAudio() {
        console.log("Initializing audio...");

        // 確保旧オーディオインスタンスを削除
        let oldAudio = document.getElementById("myAudio");
        if (oldAudio) {
            oldAudio.pause();
            oldAudio.currentTime = 0;
            oldAudio.remove();
        }

        let audioContainer = document.getElementById("audio-container");

        let newAudio = document.createElement("audio");
        newAudio.id = "myAudio";
        newAudio.controls = true;
        newAudio.autoplay = true; // 次のカードに移動した際に自動再生
        newAudio.loop = false;

        let source = document.createElement("source");
        source.src = "{{正面}}"; // ここを実際の音声ファイルのURLに置き換える
        source.type = "audio/mpeg";

        newAudio.appendChild(source);
        audioContainer.appendChild(newAudio);

        // グローバル変数を更新
        window.audio = newAudio;

        // イベントリスナーを追加
        addListeners();
    }

    function addListeners() {
        if (!audio) {
            console.error("音频未初始化！");
            return;
        }
        document.getElementById("startPause").addEventListener("click", pauseEveryCustom);
        document.getElementById("stopPause").addEventListener("click", stopAutoPause);
        document.getElementById("reversePlay").addEventListener("click", toggleReverse);
        document.getElementById("loopToggle").addEventListener("click", toggleLoop);

        // 确保页面加载完成后启动自动暂停
        pauseEveryCustom();
    }

    function pauseEveryCustom() {
        if (!audio) return;

        // 再生時間と停止時間を取得
        let playDuration = parseFloat(document.getElementById("playTime").value) * 1000;
        let pauseDuration = parseFloat(document.getElementById("pauseTime").value) * 1000;

        // 前回のタイマーをクリア
        if (window.pauseInterval) {
            clearTimeout(window.pauseInterval);
            window.pauseInterval = null; // タイマーをリセット
        }

        // 手動停止フラグをリセット
        window.isPausedManually = false;

        // 音声の状態をリセット
        audio.pause();
        audio.currentTime = 0; // 再生位置をリセット

        // 再生と停止を繰り返すループ関数
        function playAndPauseLoop() {
            // 手動停止されている場合はループを終了
            if (window.isPausedManually) {
                console.log("Playback manually stopped.");
                return;
            }

            // 再生を開始
            audio.play();
            console.log("Playing audio for " + playDuration + "ms");

            // 再生時間が経過したら停止
            window.pauseInterval = setTimeout(() => {
                audio.pause(); // 再生を停止
                console.log("Pausing audio for " + pauseDuration + "ms");

                // 停止時間が経過したら再度再生
                window.pauseInterval = setTimeout(() => {
                    audio.currentTime = 0; // 再生位置をリセット
                    playAndPauseLoop();
                }, pauseDuration);
            }, playDuration);
        }

        // 再生ループを開始
        playAndPauseLoop();
    }

    function stopAutoPause() {
        // タイマーをクリア
        if (window.pauseInterval) {
            clearTimeout(window.pauseInterval);
            window.pauseInterval = null; // タイマーをリセット
        }

        // 音声を停止し、再生位置をリセット
        if (audio) {
            audio.pause();
            audio.currentTime = 0; // 再生位置をリセット
        }

        // 再生ループを完全に停止
        window.isPausedManually = true;

        console.log("Auto pause stopped.");
    }

    function toggleReverse() {
        if (!audio) return;
        let reverseSeconds = parseFloat(document.getElementById("reverseTime").value);
        audio.pause();
        audio.currentTime = Math.max(audio.currentTime - reverseSeconds, 0);
        audio.play();
    }

    function toggleLoop() {
        if (!audio) return;
        window.isLooping = !window.isLooping;
        audio.loop = window.isLooping;
        document.getElementById("loopToggle").innerText = window.isLooping ? "循环播放（已开）" : "循环播放（已关）";
    }

    // 页面加载时立即初始化音频
    initializeAudio();
</script>
